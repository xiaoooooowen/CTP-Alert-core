# CTP-Alert-core 技术文档

## 一、模块概述

CTP-Alert-core 是期货云端预警系统的核心服务模块，主要功能包括：
- 基于 CTP 行情 SDK，实时订阅期货市场数据。
- 通过 MySQL 数据库加载用户的预警单（alert_order），满足触发条件时发出通知。
- 提供轻量级的 C++ 实现，兼容容器化部署与本地开发调试场景。

### 应用场景
- **实时价格跟踪**：设置最新价格触发的高频风控/策略提醒。
- **定时监控触发**：在指定的时间点向用户发送通知。
- **扩展性需求**：支持通过接口扩展邮件、短信或 Webhook 自定义通知方式。

---

## 二、技术亮点与选型

### 技术亮点 ✨

1. **高度灵活的配置管理**：
   - 配置优先级：环境变量 > `config.ini` > 默认值。
   - 特别适配云端容器调度与本地开发调试环境。

2. **行业标准接口接入**：
   - 使用 CTP 行情 SDK（CThostFtdcMdApi），具备高吞吐、低延迟特性，完全兼容交易所前置机接口。

3. **高效的 MySQL 数据库访问**：
   - 基于 MySQL Connector/C++，实现预警单的高效查询、更新操作。
   - 支持 JDBC 风格，便于与运维监控系统对接。

4. **线程隔离与安全并发设计**：
   - 行情网络回调由 SDK 自带线程池管理，避免阻塞。
   - 后台线程定期从数据库拉取预警信息，与回调线程逻辑隔离。
   - 使用互斥锁保护内存状态（行情与预警缓存）并减少锁竞争。

5. **增强的安全性与可维护性**：
   - 去除硬编码凭证，所有配置通过环境变量或外部加密存储。
   - 避免回调中长时间阻塞的同步操作，设计了轻量级异步触发机制。

6. **容错机制构建**：
   - 订阅与登录包含重试逻辑。
   - 支持连接状态跟踪（m_isConnected/m_isLoggedIn），为自动重连提供基础保障。

7. **通知机制可扩展**：
   - 支持通过抽象 `INotifier` 插入邮件、短信、Webhook 等多种通知形式，轻松适配用户需求变化。

---

### 核心技术选型

| 领域         | 技术选型                      | 选型理由                                                |
| ------------ | ----------------------------- | ------------------------------------------------------ |
| 行情接入     | CTP SDK (CThostFtdcMdApi)     | 国内期货行业标准，事件驱动，深度行情支持，低延迟       |
| 数据库接入   | MySQL Connector/C++           | 原生 C++ API，安全高效，支持事务和预编译语句           |
| 并发编程     | C++11 原生线程和锁            | 无额外依赖，轻量快速，延迟可控                         |
| 配置管理     | INI 文件 + 环境变量           | 既适合团队共享（文件配置），也支持自动化（环境变量）    |
| 日志         | printf（当前）                | 快速实现调试（建议替换为 spdlog，支持格式化结构化日志）|

---

## 三、完整业务流程

以下为 CTP-Alert-core 服务的全流程说明：

### 1. 程序启动
- **入口函数**：`main()` 调用 `StartMarketService()` 启动服务。
- **配置加载**：
  - 优先加载环境变量，使用 `std::getenv` 读取。
  - 若无环境变量，则回退读取 `config.ini` 示例配置。

### 2. 行情连接与认证
- **初始化与连接**：
  - 创建 `CThostFtdcMdApi`，调用 `RegisterSpi()` 注册回调实例。
  - 调用 `Init()` 启动 SDK，连接前置机。
- **登录认证**：
  - 成功建联后，触发 `OnFrontConnected()`，构造登录字段 `CThostFtdcReqUserLoginField` 并调用 `ReqUserLogin()`。
  - 成功登录后触发 `OnRspUserLogin()`，检查返回状态并更新 `m_isLoggedIn` 状态。

### 3. 行情订阅
- **订阅过程**：
  - 登录后调用 `subscribe(contracts)` 方法订阅合约列表。
  - 接收 `vector<string>` 合约名，将其转为 `char*[]` 调用 SDK 的 `SubscribeMarketData()`。
  - 若订阅失败，进入自动重试逻辑。

### 4. 后台数据加载
- **预警加载线程**：
  - 调用 `StartAlertReloadThread()`，此时会启动独立线程。
  - 每 3 秒调用 `ReloadAlertsFromDB()`，从数据库加载符合条件的预警条目（state=0）。

### 5. 行情处理与触发监控
- **行情回调**：
  - 调用 SDK 回调 `OnRtnDepthMarketData()`，更新 `m_lastPrices` 行情实时缓存（加锁保护）。
- **预警触发判断**：
  - 调用 `CheckAlert(symbol, price)`，从内存缓存中读取预警条目。
  - 判断是否满足价格区间（max_price 或 min_price）及触发时间（trigger_time）。

### 6. 通知发送与落库
- **通知执行**：
  - 针对触发的预警条目，调用 `INotifier` 接口发送实际通知（如邮件、日志）。
- **数据库状态更新**：
  - 调用 `MarkAlertTriggered(orderId)` 将数据库条目状态置为 state=1。
  - 清理内存中的触发记录。

### 7. 断线与重连
- **连接状态跟踪**：
  - `OnFrontDisconnected()` 被触发时清理连接状态（如 m_isConnected/m_isLoggedIn）。
- **改进建议**：采用指数退避重连机制，并实现登录失败后的回退策略。

---

## 四、部署与调试配置

### 配置要点：
1. **Visual Studio 工程配置**：
   - 在属性页中配置 CTP SDK 和 MySQL Connector 的 `include` 与 `lib` 路径。
   - 链接器附加依赖项中添加：`mysqlcppconn.lib`，`thostmduserapi.lib`。

2. **运行依赖**：
   - 确保运行路径下包含 `thostmduserapi.dll` 和 MySQL Connector 依赖 DLL。
   - 环境变量注入敏感账号密码，避免在 `config.ini` 写入明文配置。

---

## 五、改进建议

| 改进方向                | 具体描述                                                |
| ----------------------- | ------------------------------------------------------- |
| **异步优化**            | 将 DB 操作与通知发送异步化，采用线程池或工作队列         |
| **数据库连接池支持**    | 减少频繁连接开销，提升访问性能                           |
| **增强容错能力**        | 使用熔断机制、可配置的最大重试次数与退避重连策略         |
| **日志升级**            | 引入 `spdlog`，支持日志分级、结构化输出及文件滚动        |
| **监控与指标暴露**      | 集成 Prometheus exporter，追踪实时告警指标与延迟         |
| **测试覆盖率提高**      | 使用 GoogleTest/Catch2 对核心逻辑 (`CheckAlert`) 进行单测 |

---

## 六、总结

CTP-Alert-core 凭借其灵活配置机制、轻量安全的设计和极强的拓展能力，在期货系统实时监控场景中具备显著优势。未来，我们将持续优化服务性能，增强容错能力，使其在低延迟和高频业务需求中发挥更大价值。

> **完整代码与文档地址**：[RV64G/FuturesCloudSentinel](https://github.com/RV64G/FuturesCloudSentinel)  
> 欢迎社区贡献与反馈！😊